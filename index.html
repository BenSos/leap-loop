<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Leap Loops</title>
</head>
<body>

<div id="controls">
	<a href="#play">play</a> |
	<a href="#pause">pause</a> |
	<a href="#piano1">piano 1</a> |
	<a href="#piano2">piano 2</a> |
	<a href="#piano3">piano 3</a> |
	<a href="#string1">string 1</a> |
	<a href="#string2">string 2</a> |
	<a href="#string3">string 3</a>
</div>

<div id="status">Hands: 0, Pointables: 0</div>

<script src="js/leap.min.js"></script>
<script type="text/javascript">
	var Loop = function(param) {
		this.init(param);
	}

	Loop.prototype = {
		mp3 		: '',
		audio 		: null,
		mediagroup	: 'mediagroup',
		muted		: true,
		loop		: true,
		controller	: null,
		id			: '',
		state		: 0,
		states		: ['pause', 'play'],
		param		: null,
		volume		: 1,

		init : function(param)
		{
			this.mp3 			= param.mp3;
			
			var audio 			= new Audio(this.mp3);
			audio.mediagroup 	= param.mediagroup || this.mediagroup;
			audio.muted 		= param.muted || param.muted === false ? param.muted : this.muted;
			audio.loop			= param.loop || param.loop === false ? param.loop : this.loop;
			this.id 			= this.mp3.substring(this.mp3.lastIndexOf('/') + 1, this.mp3.lastIndexOf('.'));
			audio.id			= this.id;
			audio.volume		= param.volume || this.volume;

			this.audio 			= audio;

			this.param			= param;
		},

		play : function(id)
		{
			if (id !== this.id) { this.audio.play(); } else { this.changeState(false); }
		},

		pause : function(id)
		{
			this.changeState(true);
		},

		toggle : function(id)
		{
			this[this.states[1 - this.state]](id);
		},

		changeState : function(isMuted) {
			this.audio.muted = isMuted;
			this.state = 1 - this.state;
		}
	}

	var Event = {
		fire : function(name, param, target)
		{
			target = target || document;

			var e = document.createEvent('Events');
			e.initEvent(name, true, false);
			if (param) {
				for (var p in param) {
					if (param.hasOwnProperty(p)) {
						e[p] = param[p];
					}
				}
			}

			target.dispatchEvent(e);
		}
	}

	var Controller = {
		loops	: {},
		state	: 0,
		states	: ['pause', 'play'],
		events	: { hands:[ [] , [[],[],[],[],[],[]] , [[],[],[],[],[],[]] ] },

		init	: function(loops)
		{
			for (var i = loops.length; i--; ) {
				this.loops[loops[i].id] = loops[i];
				if (loops[i].param.hands && loops[i].param.pointables) {
					this.events.hands[loops[i].param.hands][loops[i].param.pointables].push(loops[i].id);
				}
				/*if (loops[i].param.hands) {
					this.events.hands[loops[i].param.hands].push(loops[i].id);
				}
				if (loops[i].param.pointables) {
					this.events.hands[loops[i].param.pointables].push(loops[i].id);
				}*/
			}

			var that = this;
			document.addEventListener('leap', function(e) {
				e.preventDefault();
				if (that.loops[e.id]) {
					that.toggle(e.id);
				}
			}, false);
		},

		play	: function(id)
		{
			this.changeState('play', id);
		},

		pause	: function(id)
		{
			this.changeState('pause', id);
		},

		toggle	: function(id)
		{
			if (id) {
				this.loops[id].toggle(id);
			}
		},

		changeState	: function(state, id) {
			for (var i = 0, l = loops.length; i < l; ++i) {
				loops[i][state](id);
			}

			this.state = state;
		},

		getFrame : function(frame) {
			document.getElementById('status').innerHTML = 'Hands: ' + frame.hands.length + ', Pointables: ' + frame.pointables.length;
			this.raiseEvent(frame.hands.length, frame.pointables.length);
		},

		raiseEvent : function(hands, pointables) {
			var events = this.events.hands,
				playing = [];

			for (var h = 1; h <= hands; ++h) {
				for (var p = 1; p <= pointables; ++p) {
					for (var i = 0, l = events[h][p].length; i < l; ++i) {
						playing.push(events[h][p][i]);
					}
				}
			}

			for (var loop in loops) {
				if (playing.indexOf(loop)) {
					loops[loop].play(loop);
				} else {
					loops[loop].stop(loop);
				}
			}
		}
	}

	var loops = [];
	loops.push(new Loop({mp3:'loops/piano_loop_1.mp3', muted:false, volume:.4, hands:1, pointables:1}));
	loops.push(new Loop({mp3:'loops/piano_loop_2.mp3', muted:true, volume:.4, hands:1, pointables:2}));
	loops.push(new Loop({mp3:'loops/piano_loop_3.mp3', muted:true, volume:.4, hands:1, pointables:3}));
	loops.push(new Loop({mp3:'loops/string_loop_1.mp3', muted:true, volume:.4, hands:1, pointables:4}));
	loops.push(new Loop({mp3:'loops/string_loop_2.mp3', muted:true, volume:1, hands:1, pointables:5}));
	loops.push(new Loop({mp3:'loops/string_loop_3.mp3', muted:true, volume:1, hands:2, pointables:1}));

	Controller.init(loops);

	var Audio = {
		init : function()
		{
			document.getElementById('controls').addEventListener('click', function(e) {
				e.stopPropagation();
				e.preventDefault();
				if (e.target.href) {
					var fragment = e.target.href.substring(e.target.href.indexOf('#'));
					switch(fragment) {
						case '#play':
							Controller.play();
							break;
						case '#pause':
							Controller.pause();
							break;
						case '#piano1':
							Event.fire('leap', {id:'piano_loop_1'});
							break;
						case '#piano2':
							//$('#strings_loop_1')[0].muted = false;
							Event.fire('leap', {id:'piano_loop_2'});
							break;
						case '#piano3':
							Event.fire('leap', {id:'piano_loop_3'});
							break;
						case '#string1':
							Event.fire('leap', {id:'string_loop_1'});
							break;
						case '#string2':
							Event.fire('leap', {id:'string_loop_2'});
							break;
						case '#string3':
							Event.fire('leap', {id:'string_loop_3'});
							break;
					}
				}
			}, false);
		}
	}

	Audio.init();

	Leap.loop(function(frame) { Controller.getFrame(frame); });


</script>

</body>
</html>